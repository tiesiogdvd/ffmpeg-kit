name: Build FFmpegKit for Android (Audio Optimized)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NDK_VERSION: "26.2.11394342"

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_ROOT: ${{ github.workspace }}/android-sdk/ndk/26.2.11394342

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: |
        sdkmanager --install "ndk;${{ env.NDK_VERSION }}"

    - name: Check available options
      run: |
        chmod +x android.sh
        ./android.sh --help

    - name: Build FFmpeg
      run: |
        ./android.sh \
          --enable-armeabi-v7a \
          --enable-arm64 \
          --enable-x86 \
          --enable-x86_64 \
          --enable-android-ndk-r26 \
          --target-sdk-version=21 \
          --min-sdk-version=21 \
          --enable-ffmpeg-version=6.0 \
          --enable-version3 \
          --enable-pic \
          --enable-jni \
          --enable-optimizations \
          --disable-static \
          --enable-shared \
          --enable-pthreads \
          --enable-small \
          --disable-debug \
          --enable-lto \
          --disable-neon-clobber-test \
          --disable-programs \
          --disable-postproc \
          --disable-swscale \
          --enable-swresample \
          --disable-videotoolbox \
          --disable-vaapi \
          --disable-vdpau \
          --disable-cuda \
          --disable-cuvid \
          --disable-nvenc \
          --disable-nvdec \
          --disable-v4l2-m2m \
          --disable-dxva2 \
          --disable-d3d11va \
          --disable-ffplay \
          --disable-ffprobe \
          --disable-network \
          --disable-protocols \
          --disable-filters \
          --disable-doc \
          --disable-htmlpages \
          --disable-manpages \
          --disable-podpages \
          --disable-txtpages \
          --enable-lame \
          --enable-libilbc \
          --enable-libvorbis \
          --enable-opencore-amr \
          --enable-opus \
          --enable-shine \
          --enable-soxr \
          --enable-speex \
          --enable-twolame \
          --enable-vo-amrwbenc \
          --enable-libopus \
          --enable-fft \
          --enable-rdft \
          --enable-avfilter \
          --enable-filter=aresample \
          --enable-filter=volume \
          --enable-filter=anull \
          --enable-filter=aformat \
          --enable-filter=amix \
          --enable-filter=afade \
          --enable-filter=equalizer \
          --enable-filter=dynaudnorm \
          --enable-filter=silenceremove

    - name: Upload arm64-v8a artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ffmpeg-android-arm64-v8a
        path: prebuilt/android-arm64-v8a/ffmpeg/
        if-no-files-found: warn

    - name: Upload armeabi-v7a artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ffmpeg-android-armeabi-v7a
        path: prebuilt/android-armeabi-v7a/ffmpeg/
        if-no-files-found: warn

    - name: Upload x86 artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ffmpeg-android-x86
        path: prebuilt/android-x86/ffmpeg/
        if-no-files-found: warn

    - name: Upload x86_64 artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ffmpeg-android-x86_64
        path: prebuilt/android-x86_64/ffmpeg/
        if-no-files-found: warn
