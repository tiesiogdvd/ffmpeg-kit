name: Build FFmpegKit for Android

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NDK_VERSION: "26.2.11394342"

jobs:
  build:
    strategy:
      matrix:
        arch: [arm-v7a, arm-v7a-neon, arm64-v8a, x86, x86-64]
      fail-fast: false
    
    runs-on: ubuntu-latest
    
    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_ROOT: ${{ github.workspace }}/android-sdk/ndk/26.2.11394342

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: |
        sdkmanager --install "ndk;${{ env.NDK_VERSION }}"

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pkg-config \
          ninja-build \
          yasm \
          nasm \
          autoconf \
          automake \
          libtool \
          cmake

    - name: Build FFmpeg for ${{ matrix.arch }}
      run: |
        chmod +x android.sh
        ./android.sh \
          --api-level=21 \
          -s \
          --enable-android-media-codec \
          --enable-android-zlib \
          --enable-gnutls \
          --enable-gmp \
          --disable-arm-v7a \
          --disable-arm-v7a-neon \
          --disable-arm64-v8a \
          --disable-x86 \
          --disable-x86-64 \
          --enable-${{ matrix.arch }}

    - name: Upload ${{ matrix.arch }} artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ffmpeg-android-${{ matrix.arch }}
        path: prebuilt/android-${{ matrix.arch }}/ffmpeg/
        if-no-files-found: warn
