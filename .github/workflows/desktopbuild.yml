name: Build FFmpeg for Linux and Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          # Linux builds
          - name: linux-x86_64
            os: ubuntu-latest
            target_os: linux
            arch: x86_64
            cc: gcc
            cxx: g++
            configure_arch: x86_64
            cpu: x86-64
            packages: ""
            cross_prefix: ""
            
          - name: linux-arm64
            os: ubuntu-latest
            target_os: linux
            arch: arm64
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
            configure_arch: aarch64
            cpu: armv8-a
            packages: "gcc-aarch64-linux-gnu g++-aarch64-linux-gnu"
            cross_prefix: aarch64-linux-gnu-
            
          - name: linux-armv7
            os: ubuntu-latest
            target_os: linux
            arch: armv7
            cc: arm-linux-gnueabihf-gcc
            cxx: arm-linux-gnueabihf-g++
            configure_arch: arm
            cpu: armv7-a
            packages: "gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf"
            cross_prefix: arm-linux-gnueabihf-
            
          # Windows builds
          - name: windows-x86_64
            os: ubuntu-latest
            target_os: mingw32
            arch: x86_64
            cc: x86_64-w64-mingw32-gcc
            cxx: x86_64-w64-mingw32-g++
            configure_arch: x86_64
            cpu: x86-64
            packages: "gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64"
            cross_prefix: x86_64-w64-mingw32-
            
          - name: windows-x86
            os: ubuntu-latest
            target_os: mingw32
            arch: x86
            cc: i686-w64-mingw32-gcc
            cxx: i686-w64-mingw32-g++
            configure_arch: x86
            cpu: i686
            packages: "gcc-mingw-w64-i686 g++-mingw-w64-i686"
            cross_prefix: i686-w64-mingw32-
            
      fail-fast: false
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --fix-missing \
          build-essential \
          pkg-config \
          ninja-build \
          yasm \
          nasm \
          autoconf \
          automake \
          libtool \
          cmake \
          perl \
          ${{ matrix.packages }} || \
        sudo apt-get install -y --fix-missing \
          build-essential \
          pkg-config \
          ninja-build \
          yasm \
          nasm \
          autoconf \
          automake \
          libtool \
          cmake \
          perl \
          ${{ matrix.packages }}

    - name: Build mbedTLS
      run: |
        git clone --depth 1 --branch v3.5.0 https://github.com/Mbed-TLS/mbedtls.git
        cd mbedtls
        
        # Create installation directory
        mkdir -p ${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls
        
        # Configure for static-only build with cross-compilation support
        CMAKE_FLAGS="-DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls"
        CMAKE_FLAGS="$CMAKE_FLAGS -DENABLE_PROGRAMS=OFF"
        CMAKE_FLAGS="$CMAKE_FLAGS -DENABLE_TESTING=OFF"
        CMAKE_FLAGS="$CMAKE_FLAGS -DBUILD_SHARED_LIBS=OFF"
        CMAKE_FLAGS="$CMAKE_FLAGS -DUSE_STATIC_MBEDTLS_LIBRARY=ON"
        CMAKE_FLAGS="$CMAKE_FLAGS -DUSE_SHARED_MBEDTLS_LIBRARY=OFF"
        
        if [ "${{ matrix.cross_prefix }}" != "" ]; then
          CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_C_COMPILER=${{ matrix.cc }}"
          CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}"
        fi
        
        cmake . -B build $CMAKE_FLAGS
        make -C build -j$(nproc)
        make -C build install

    - name: Create mbedTLS pkg-config files
      run: |
        MBEDTLS_PREFIX="${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls"
        mkdir -p "$MBEDTLS_PREFIX/lib/pkgconfig"
        
        # Create mbedtls.pc
        cat > "$MBEDTLS_PREFIX/lib/pkgconfig/mbedtls.pc" << EOF
        prefix=${MBEDTLS_PREFIX}
        exec_prefix=\${prefix}
        libdir=\${exec_prefix}/lib
        includedir=\${prefix}/include
        
        Name: mbedTLS
        Description: Light-weight cryptographic and SSL/TLS library
        Version: 3.5.0
        Requires: 
        Libs: -L\${libdir} -lmbedtls -lmbedx509 -lmbedcrypto
        Cflags: -I\${includedir}
        EOF

    - name: Verify mbedTLS installation
      run: |
        echo "=== mbedTLS installation verification ==="
        ls -la ${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls/
        echo "=== Include directory ==="
        ls -la ${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls/include/
        echo "=== Lib directory ==="
        ls -la ${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls/lib/
        echo "=== Static library verification ==="
        file ${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls/lib/libmbedtls.a || echo "No libmbedtls.a"
        file ${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls/lib/libmbedx509.a || echo "No libmbedx509.a"
        file ${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls/lib/libmbedcrypto.a || echo "No libmbedcrypto.a"

    - name: Download and Extract FFmpeg
      run: |
        git clone https://github.com/FFmpeg/FFmpeg.git ffmpeg
        cd ffmpeg
        git checkout release/6.1

    - name: Build FFmpeg with Static mbedTLS
      working-directory: ffmpeg
      run: |
        export PKG_CONFIG_PATH=${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls/lib/pkgconfig:$PKG_CONFIG_PATH
        export MBEDTLS_DIR=${{ github.workspace }}/prebuilt/${{ matrix.name }}/mbedtls
        
        echo "=== Environment verification ==="
        echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
        echo "MBEDTLS_DIR: $MBEDTLS_DIR"
        
        # Base configuration for static linking with embedded mbedTLS
        CONFIGURE_FLAGS="
          --prefix=${{ github.workspace }}/prebuilt/${{ matrix.name }}/ffmpeg
          --pkg-config=pkg-config
          --enable-version3
          --target-os=${{ matrix.target_os }}
          --arch=${{ matrix.configure_arch }}
          --cpu=${{ matrix.cpu }}
          --enable-gpl
          --enable-nonfree
          --enable-mbedtls
          --enable-protocol=http
          --enable-protocol=https
          --enable-protocol=file
          --enable-protocol=tcp
          --extra-cflags=-I$MBEDTLS_DIR/include
          --extra-ldflags=-L$MBEDTLS_DIR/lib
          --extra-libs=-lmbedtls
          --extra-libs=-lmbedx509
          --extra-libs=-lmbedcrypto
          --pkg-config-flags=--static
          --enable-pic
          --enable-optimizations
          --enable-swscale
          --enable-static
          --disable-shared
          --enable-pthreads
          --disable-debug
          --disable-doc
          --disable-htmlpages
          --disable-manpages
          --disable-podpages
          --disable-txtpages
        "
        
        # Cross-compilation flags
        if [ "${{ matrix.cross_prefix }}" != "" ]; then
          CONFIGURE_FLAGS="$CONFIGURE_FLAGS
            --enable-cross-compile
            --cross-prefix=${{ matrix.cross_prefix }}
            --cc=${{ matrix.cc }}
            --cxx=${{ matrix.cxx }}
          "
        fi
        
        # Platform-specific static linking flags
        if [ "${{ matrix.target_os }}" = "mingw32" ]; then
          # Windows-specific flags for static linking
          CONFIGURE_FLAGS="$CONFIGURE_FLAGS
            --disable-w32threads
            --enable-pthreads
            --extra-ldflags=-static-libgcc
            --extra-ldflags=-static-libstdc++
            --extra-libs=-static
            --extra-libs=-lpthread
            --extra-libs=-lws2_32
            --extra-libs=-lwinmm
            --extra-libs=-lole32
            --extra-libs=-lstrmiids
            --extra-libs=-luuid
            --extra-libs=-lgdi32
            --extra-libs=-lbcrypt
            --extra-libs=-ladvapi32
            --extra-libs=-luser32
            --extra-libs=-lkernel32
          "
        else
          # Linux-specific static linking flags
          CONFIGURE_FLAGS="$CONFIGURE_FLAGS
            --extra-libs=-ldl
            --extra-libs=-lpthread
          "
        fi
        
        # ARM-specific optimizations (Linux only)
        if [ "${{ matrix.target_os }}" = "linux" ]; then
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            CONFIGURE_FLAGS="$CONFIGURE_FLAGS --enable-neon"
          elif [ "${{ matrix.arch }}" = "armv7" ]; then  
            CONFIGURE_FLAGS="$CONFIGURE_FLAGS 
              --enable-neon
              --extra-cflags=-mfpu=neon
              --extra-cflags=-mfloat-abi=hard
            "
          fi
        fi
        
        # Configure FFmpeg
        echo "=== Configuring FFmpeg ==="
        echo "Configure flags: $CONFIGURE_FLAGS"
        ./configure $CONFIGURE_FLAGS
        
        # Verify mbedTLS is detected correctly
        echo "=== Checking FFmpeg configuration ==="
        grep -i mbedtls config.log | tail -5 || echo "No mbedTLS references found"
        grep -i "ENABLED.*mbedtls" config.h || echo "mbedTLS not enabled"
        
        # Build
        echo "=== Building FFmpeg ==="
        make clean
        make -j$(nproc)
        make install

    - name: Verify mbedTLS is Embedded in FFmpeg
      run: |
        echo "=== Verifying FFmpeg static libraries ==="
        ls -la ${{ github.workspace }}/prebuilt/${{ matrix.name }}/ffmpeg/lib/
        
        # Check if mbedTLS symbols are embedded in FFmpeg libraries
        if [ "${{ matrix.target_os }}" = "mingw32" ]; then
          echo "=== Checking for mbedTLS symbols in Windows libraries ==="
          ${{ matrix.cross_prefix }}nm ${{ github.workspace }}/prebuilt/${{ matrix.name }}/ffmpeg/lib/libavformat.a | grep -i mbedtls | head -5 || echo "No mbedTLS symbols found"
          echo "=== Verifying no external mbedTLS dependencies ==="
          ${{ matrix.cross_prefix }}objdump -p ${{ github.workspace }}/prebuilt/${{ matrix.name }}/ffmpeg/lib/libavformat.a | grep -i mbedtls || echo "No external mbedTLS dependencies (good!)"
        else
          echo "=== Checking for mbedTLS symbols in Linux libraries ==="
          nm ${{ github.workspace }}/prebuilt/${{ matrix.name }}/ffmpeg/lib/libavformat.a | grep -i mbedtls | head -5 || echo "No mbedTLS symbols found"
          echo "=== Verifying no external mbedTLS dependencies ==="
          objdump -p ${{ github.workspace }}/prebuilt/${{ matrix.name }}/ffmpeg/lib/libavformat.a | grep -i mbedtls || echo "No external mbedTLS dependencies (good!)"
        fi

    - name: Create tarball
      run: |
        cd ${{ github.workspace }}/prebuilt/${{ matrix.name }}/ffmpeg
        if [ "${{ matrix.target_os }}" = "mingw32" ]; then
          # For Windows, create a zip file
          zip -r ../../../ffmpeg-${{ matrix.name }}-static.zip .
        else
          # For Linux, create a tarball
          tar -czf ../../../ffmpeg-${{ matrix.name }}-static.tar.gz .
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-${{ matrix.name }}-static
        path: |
          ${{ github.workspace }}/prebuilt/${{ matrix.name }}/ffmpeg/
          ${{ github.workspace }}/ffmpeg-${{ matrix.name }}-static.*

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          ffmpeg-*-static/ffmpeg-*-static.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
